<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - TTS Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            min-height: 100vh;
            padding-top: 2rem;
        }
        
        .sidebar a {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            display: block;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar a:hover, .sidebar a.active {
            background: rgba(255,255,255,0.1);
            color: white;
            padding-left: 2rem;
        }
        
        .sidebar a i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            padding: 2rem;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .profile-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        
        .plan-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            position: relative;
        }
        
        .plan-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .plan-card.current {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }
        
        .plan-card.current::before {
            content: 'Current Plan';
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .plan-card.recommended {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .plan-card.recommended::before {
            content: 'Recommended';
            position: absolute;
            top: -10px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .plan-header {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .plan-features {
            list-style: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }
        
        .plan-features li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .plan-features li:last-child {
            border-bottom: none;
        }
        
        .plan-features li i {
            width: 20px;
            margin-right: 10px;
        }
        
        .plan-features li .fa-check {
            color: #28a745;
        }
        
        .plan-features li .fa-times {
            color: #dc3545;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
        }
        
        .tab-content {
            padding: 1rem 0;
        }
        
        .usage-chart {
            height: 200px;
            position: relative;
            margin: 1rem 0;
        }
        
        .chart-bar {
            position: absolute;
            bottom: 0;
            background: var(--primary-color);
            width: 40px;
            border-radius: 5px 5px 0 0;
            transition: height 0.3s;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-microphone-alt me-2"></i>TTS Generator
            </a>
            <div class="d-flex align-items-center">
                <span class="me-3">Welcome, {{ user.username }}</span>
                <a href="/profile" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-user"></i>
                </a>
                <a href="/logout" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar">
                <a href="/dashboard">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="/tts">
                    <i class="fas fa-user"></i> Single Voice
                </a>
                <a href="/multi-voice">
                    <i class="fas fa-users"></i> Multi-Voice
                </a>
                <a href="/qa-dialogue">
                    <i class="fas fa-comments"></i> Q&A Dialogue
                </a>
                {% if user.role == 'admin' %}
                <a href="/admin">
                    <i class="fas fa-cog"></i> Admin Panel
                </a>
                {% endif %}
            </div>
            
            <div class="col-md-9 col-lg-10 main-content">
                <div class="profile-container">
                    <h2 class="mb-4"><i class="fas fa-user-circle me-2"></i>My Profile</h2>
                    
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="profileTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#info">
                                <i class="fas fa-info-circle me-2"></i>Account Info
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#subscription">
                                <i class="fas fa-crown me-2"></i>Subscription
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#security">
                                <i class="fas fa-shield-alt me-2"></i>Security
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#usage">
                                <i class="fas fa-chart-bar me-2"></i>Usage Stats
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="profileTabsContent">
                        <!-- Account Info Tab -->
                        <div class="tab-pane fade show active" id="info">
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <form id="profileForm">
                                        <h5 class="mb-3">Personal Information</h5>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-control" value="{{ user.username }}" disabled>
                                            <small class="text-muted">Username cannot be changed</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="full_name" value="{{ user.full_name }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" value="{{ user.email }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Account Type</label>
                                            <input type="text" class="form-control" value="{{ user.role|title }}" disabled>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Member Since</label>
                                            <input type="text" class="form-control" value="{{ user.created_at[:10] }}" disabled>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>Save Changes
                                        </button>
                                    </form>
                                </div>
                                
                                <div class="col-md-6">
                                    <h5 class="mb-3">Current Plan</h5>
                                    <div class="plan-card current">
                                        <div class="plan-header">
                                            <h4>{{ subscription_plans[user.subscription.plan].name }}</h4>
                                            <div class="plan-price">{{ subscription_plans[user.subscription.plan].price }}</div>
                                            <small class="text-muted">Expires: {{ user.subscription.expires_at[:10] }}</small>
                                        </div>
                                        
                                        <ul class="plan-features">
                                            {% for feature in subscription_plans[user.subscription.plan].features %}
                                            <li><i class="fas fa-check"></i> {{ feature }}</li>
                                            {% endfor %}
                                            {% for limitation in subscription_plans[user.subscription.plan].limitations %}
                                            <li><i class="fas fa-times"></i> {{ limitation }}</li>
                                            {% endfor %}
                                        </ul>
                                        
                                        <a href="#subscription" class="btn btn-outline-primary w-100" onclick="switchTab('subscription')">
                                            <i class="fas fa-exchange-alt me-2"></i>Change Plan
                                        </a>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h5>Account Statistics</h5>
                                        <div class="row text-center mt-3">
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <h3 class="text-primary">{{ user.usage.total_requests }}</h3>
                                                    <small class="text-muted">Total Requests</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="p-3 border rounded">
                                                    <h3 class="text-success">{{ user.usage.characters_used|int|format(',d') }}</h3>
                                                    <small class="text-muted">Characters Used</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subscription Tab -->
                        <div class="tab-pane fade" id="subscription">
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <div class="plan-card {% if user.subscription.plan == 'free' %}current{% endif %}">
                                        <div class="plan-header">
                                            <h4>Free</h4>
                                            <div class="plan-price">$0</div>
                                            <small class="text-muted">For beginners</small>
                                        </div>
                                        
                                        <ul class="plan-features">
                                            <li><i class="fas fa-check"></i> 30,000 characters/week</li>
                                            <li><i class="fas fa-check"></i> Single Voice TTS</li>
                                            <li><i class="fas fa-check"></i> Basic Audio Effects</li>
                                            <li><i class="fas fa-times"></i> Multi-Voice</li>
                                            <li><i class="fas fa-times"></i> Q&A Dialogue</li>
                                            <li><i class="fas fa-times"></i> Priority Processing</li>
                                        </ul>
                                        
                                        {% if user.subscription.plan == 'free' %}
                                        <button class="btn btn-outline-secondary w-100" disabled>
                                            <i class="fas fa-check me-2"></i>Current Plan
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-primary w-100" onclick="selectPlan('free')">
                                            <i class="fas fa-exchange-alt me-2"></i>Switch to Free
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="plan-card recommended {% if user.subscription.plan == 'premium' %}current{% endif %}">
                                        <div class="plan-header">
                                            <h4>Premium</h4>
                                            <div class="plan-price">$9.99<span style="font-size: 1rem">/month</span></div>
                                            <small class="text-muted">Most popular</small>
                                        </div>
                                        
                                        <ul class="plan-features">
                                            <li><i class="fas fa-check"></i> 1M characters/month</li>
                                            <li><i class="fas fa-check"></i> All Voices</li>
                                            <li><i class="fas fa-check"></i> Multi-Voice TTS</li>
                                            <li><i class="fas fa-check"></i> Q&A Dialogue</li>
                                            <li><i class="fas fa-check"></i> Priority Processing</li>
                                            <li><i class="fas fa-times"></i> Unlimited Characters</li>
                                        </ul>
                                        
                                        {% if user.subscription.plan == 'premium' %}
                                        <button class="btn btn-outline-secondary w-100" disabled>
                                            <i class="fas fa-check me-2"></i>Current Plan
                                        </button>
                                        {% else %}
                                        <button class="btn btn-success w-100" onclick="selectPlan('premium')">
                                            <i class="fas fa-shopping-cart me-2"></i>Upgrade to Premium
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="plan-card {% if user.subscription.plan == 'pro' %}current{% endif %}">
                                        <div class="plan-header">
                                            <h4>Pro</h4>
                                            <div class="plan-price">$29.99<span style="font-size: 1rem">/month</span></div>
                                            <small class="text-muted">For professionals</small>
                                        </div>
                                        
                                        <ul class="plan-features">
                                            <li><i class="fas fa-check"></i> Unlimited Characters</li>
                                            <li><i class="fas fa-check"></i> All Features</li>
                                            <li><i class="fas fa-check"></i> Priority Support</li>
                                            <li><i class="fas fa-check"></i> Batch Processing</li>
                                            <li><i class="fas fa-check"></i> Custom Voices</li>
                                            <li><i class="fas fa-check"></i> API Access</li>
                                        </ul>
                                        
                                        {% if user.subscription.plan == 'pro' %}
                                        <button class="btn btn-outline-secondary w-100" disabled>
                                            <i class="fas fa-check me-2"></i>Current Plan
                                        </button>
                                        {% else %}
                                        <button class="btn btn-primary w-100" onclick="selectPlan('pro')">
                                            <i class="fas fa-rocket me-2"></i>Upgrade to Pro
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-4">
                                <h6><i class="fas fa-info-circle me-2"></i>Plan Change Information</h6>
                                <ul class="mb-0">
                                    <li>Downgrading to Free plan will immediately limit your features</li>
                                    <li>Upgrading plans takes effect immediately</li>
                                    <li>Unused characters from previous plan do not carry over</li>
                                    <li>Contact admin for enterprise/custom plans</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security">
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <form id="passwordForm">
                                        <h5 class="mb-3">Change Password</h5>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="current_password" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="new_password" required>
                                            <small class="text-muted">Minimum 6 characters</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirm_new_password" required>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-key me-2"></i>Change Password
                                        </button>
                                    </form>
                                    
                                    <div class="mt-4">
                                        <h5>Security Settings</h5>
                                        <div class="form-check form-switch mt-3">
                                            <input class="form-check-input" type="checkbox" id="twoFactor" disabled>
                                            <label class="form-check-label" for="twoFactor">
                                                Two-Factor Authentication
                                                <small class="text-muted d-block">(Coming soon)</small>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check form-switch mt-3">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked disabled>
                                            <label class="form-check-label" for="emailNotifications">
                                                Email Notifications
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h5 class="mb-3">Active Sessions</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Current Session</h6>
                                            <p class="mb-1"><strong>Device:</strong> Web Browser</p>
                                            <p class="mb-1"><strong>IP Address:</strong> 127.0.0.1</p>
                                            <p class="mb-0"><strong>Last Active:</strong> Just now</p>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-warning mt-4">
                                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Security Tips</h6>
                                        <ul class="mb-0">
                                            <li>Use a strong, unique password</li>
                                            <li>Never share your credentials</li>
                                            <li>Log out from public computers</li>
                                            <li>Contact support if you notice suspicious activity</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Usage Stats Tab -->
                        <div class="tab-pane fade" id="usage">
                            <div class="row mt-4">
                                <div class="col-md-8">
                                    <h5 class="mb-3">Usage Statistics</h5>
                                    
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <h6>Characters Usage</h6>
                                            <div class="usage-chart" id="usageChart">
                                                <!-- Chart will be generated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>Daily Average</h6>
                                                    <h3 class="text-primary">{{ (user.usage.characters_used / 7)|int|format(',d') }}</h3>
                                                    <small class="text-muted">characters per day</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h6>Requests</h6>
                                                    <h3 class="text-success">{{ user.usage.total_requests }}</h3>
                                                    <small class="text-muted">total requests made</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <h5 class="mb-3">Usage History</h5>
                                    
                                    <div class="list-group">
                                        {% for i in range(5) %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between">
                                                <span>Single Voice TTS</span>
                                                <small class="text-muted">2 hours ago</small>
                                            </div>
                                            <small class="text-muted">1,234 characters used</small>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="alert alert-info mt-4">
                                        <h6><i class="fas fa-lightbulb me-2"></i>Usage Tips</h6>
                                        <ul class="mb-0">
                                            <li>Free plan resets every Monday</li>
                                            <li>Premium plan resets monthly</li>
                                            <li>Consider upgrading for higher limits</li>
                                            <li>Contact support for custom limits</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="message" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <script>
        // Switch tab function
        function switchTab(tabId) {
            const tab = document.querySelector(`[href="#${tabId}"]`);
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        }
        
        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('full_name').value;
            const email = document.getElementById('email').value;
            
            const formData = new FormData();
            formData.append('full_name', fullName);
            formData.append('email', email);
            
            try {
                const response = await fetch('/api/user/update-profile', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Profile updated successfully', 'success');
                } else {
                    showToast(result.message || 'Update failed', 'error');
                }
            } catch (error) {
                showToast('Network error: ' + error.message, 'error');
            }
        });
        
        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_new_password').value;
            
            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('current_password', currentPassword);
            formData.append('new_password', newPassword);
            
            try {
                const response = await fetch('/api/user/change-password', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Password changed successfully', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    showToast(result.message || 'Password change failed', 'error');
                }
            } catch (error) {
                showToast('Network error: ' + error.message, 'error');
            }
        });
        
        // Plan selection
        function selectPlan(plan) {
            if (confirm(`Are you sure you want to switch to ${plan} plan?`)) {
                // In a real application, this would redirect to payment page
                // For demo purposes, we'll show a message
                if (plan === 'free') {
                    showToast('Plan change request submitted. Contact admin for free plan changes.', 'info');
                } else {
                    showToast(`Redirecting to ${plan} plan payment page...`, 'info');
                    // window.location.href = `/payment/${plan}`;
                }
            }
        }
        
        // Generate usage chart
        function generateUsageChart() {
            const chart = document.getElementById('usageChart');
            if (!chart) return;
            
            // Sample data for last 7 days
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const usage = [1200, 3500, 2800, 4500, 3200, 1500, 4000];
            const maxUsage = Math.max(...usage);
            
            chart.innerHTML = '';
            
            days.forEach((day, index) => {
                const barHeight = (usage[index] / maxUsage) * 150;
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${barHeight}px`;
                bar.style.left = `${index * 60 + 10}px`;
                bar.title = `${usage[index].toLocaleString()} characters`;
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.style.left = `${index * 60 + 10}px`;
                label.textContent = day;
                
                chart.appendChild(bar);
                chart.appendChild(label);
            });
        }
        
        // Toast notification
        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const colorClass = type === 'error' ? 'danger' : 
                             type === 'warning' ? 'warning' : 
                             type === 'success' ? 'success' : 'info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${colorClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.getElementById('message').innerHTML = toastHtml;
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generateUsageChart();
            
            // Activate current tab from URL hash
            const hash = window.location.hash;
            if (hash) {
                switchTab(hash.substring(1));
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
